<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Nexus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0d0d12;
            --bg-mid: #151520;
            --bg-light: #1e1e2e;
            --accent: #b4a0d4;
            --accent-hover: #c9b8e6;
            --text: #e4e0ed;
            --text-dim: #9690a8;
            --text-muted: #5c5872;
            --border: #3d3658;
            --success: #8bc4a8;
            --error: #d4a0a0;
        }

        body {
            font-family: Georgia, 'Times New Roman', serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-mid) 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header - Floating Menu Bar */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--bg-mid);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .header.scrolled {
            padding: 6px 12px;
            background: rgba(21, 21, 32, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.4);
        }

        .header.scrolled h1 {
            font-size: 1em;
        }

        .header.scrolled .header-btn {
            padding: 4px 10px;
            font-size: 0.8em;
        }

        .header h1 {
            color: var(--accent);
            font-size: 1.2em;
            font-weight: normal;
            transition: font-size 0.3s ease;
            white-space: nowrap;
        }

        .header-buttons {
            display: flex;
            gap: 6px;
        }

        .header-btn {
            background: var(--bg-light);
            color: var(--text-dim);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: var(--border);
            color: var(--text);
        }

        /* Spacer to prevent content from hiding under fixed header */
        .header-spacer {
            height: 52px;
            flex-shrink: 0;
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 1em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user {
            background: var(--bg-light);
            align-self: flex-end;
            border: 1px solid var(--border);
        }

        .message.assistant {
            background: var(--bg-mid);
            align-self: flex-start;
            border: 1px solid var(--border);
        }

        .message-role {
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 6px;
            font-family: system-ui, sans-serif;
        }

        .message.user .message-role {
            color: var(--text-dim);
        }

        .message.assistant .message-role {
            color: var(--accent);
        }

        .message-content {
            color: var(--text);
        }

        /* Welcome */
        .welcome {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .welcome h2 {
            color: var(--accent);
            font-size: 1.8em;
            margin-bottom: 16px;
            font-weight: normal;
        }

        /* Input Area */
        .input-area {
            background: var(--bg-mid);
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            max-width: 900px;
            margin: 0 auto;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #message-input {
            width: 100%;
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 16px;
            border-radius: 12px;
            font-family: Georgia, serif;
            font-size: 1em;
            resize: none;
            min-height: 48px;
            max-height: 150px;
            line-height: 1.5;
        }

        #message-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        #message-input::placeholder {
            color: var(--text-muted);
        }

        #send-btn {
            background: var(--accent);
            color: var(--bg-dark);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.2s;
            align-self: flex-end;
        }

        #send-btn:hover {
            background: var(--accent-hover);
        }

        #send-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        /* Status */
        .status {
            text-align: center;
            font-size: 0.8em;
            color: var(--text-muted);
            margin-top: 8px;
            font-family: system-ui, sans-serif;
        }

        .status.error {
            color: var(--error);
        }

        .status.success {
            color: var(--success);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-mid);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            color: var(--accent);
            margin-bottom: 16px;
            font-weight: normal;
        }

        .modal label {
            display: block;
            color: var(--text-dim);
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .modal input, .modal select {
            width: 100%;
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 16px;
        }

        .modal input:focus, .modal select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            border: none;
        }

        .modal-btn.primary {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .modal-btn.secondary {
            background: var(--bg-light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        /* Sessions list */
        .sessions-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .session-item {
            padding: 10px 12px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-item:hover {
            border-color: var(--accent);
        }

        .session-item .name {
            color: var(--text);
        }

        .session-item .date {
            color: var(--text-muted);
            font-size: 0.8em;
        }

        .session-item .delete-btn {
            color: var(--error);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 1.1em;
        }

        /* Loading animation */
        .typing-indicator {
            display: inline-block;
        }

        .typing-indicator span {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Mobile adjustments */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.1em;
            }

            .header-btn {
                padding: 6px 10px;
                font-size: 0.8em;
            }

            .message {
                max-width: 95%;
                font-size: 0.95em;
            }

            .chat-container {
                padding: 12px;
            }

            .input-area {
                padding: 12px;
            }

            #send-btn {
                padding: 12px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header" id="header">
        <h1>‚ú¶ The Nexus</h1>
        <div class="header-buttons">
            <button class="header-btn" onclick="showSettings()">‚öôÔ∏è</button>
            <button class="header-btn" onclick="showSessions()">üíæ</button>
            <button class="header-btn" onclick="newSession()">‚ú¶</button>
        </div>
    </div>
    
    <div class="header-spacer"></div>

    <div class="chat-container" id="chat-container">
        <div class="welcome">
            <h2>The Nexus Awaits</h2>
            <p>Your framework is loaded and ready.<br>Type "Begin" to start a new session.</p>
        </div>
    </div>

    <div class="input-area">
        <div class="input-container">
            <div class="input-wrapper">
                <textarea id="message-input" placeholder="Enter your action..." rows="1"></textarea>
            </div>
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
        <div class="status" id="status">Ready</div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <h3>Settings</h3>
            
            <label>Provider</label>
            <select id="provider-select" onchange="onProviderChange()">
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="google">Google AI (Gemini)</option>
            </select>
            
            <div id="anthropic-key-section">
                <label>Anthropic API Key</label>
                <input type="password" id="api-key-input" placeholder="sk-ant-...">
            </div>
            
            <div id="google-key-section" style="display: none;">
                <label>Google AI Studio API Key</label>
                <input type="password" id="google-api-key-input" placeholder="AIza...">
            </div>
            
            <label>Model</label>
            <select id="model-select">
                <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 (Balanced)</option>
                <option value="claude-opus-4-6">Claude Opus 4.6 (Best)</option>
                <option value="claude-opus-4-5">Claude Opus 4.5</option>
                <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Fast)</option>
            </select>
            
            <label>Temperature: <span id="temp-display">1.0</span></label>
            <input type="range" id="temp-slider" min="0" max="1.5" step="0.1" value="1.0" oninput="updateTempDisplay()">
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeSettings()">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Sessions Modal -->
    <div class="modal-overlay" id="sessions-modal">
        <div class="modal">
            <h3>Sessions</h3>
            <div class="sessions-list" id="sessions-list">
                <p style="color: var(--text-muted);">No saved sessions yet.</p>
            </div>
            
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button class="modal-btn secondary" style="flex:1" onclick="loadFromFile()">üìÇ Open File</button>
                <button class="modal-btn secondary" style="flex:1" onclick="saveToFile()">üíæ Download</button>
            </div>
            
            <div style="margin-bottom: 16px;">
                <button class="modal-btn secondary" style="width: 100%; background: #2a2640;" onclick="archiveAndTrim()">üì¶ Archive & Trim</button>
                <p style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Save full archive, summarize to character sheet, trim to last 10 messages</p>
            </div>
            
            <label>Session name:</label>
            <input type="text" id="session-name-input" placeholder="Session name...">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeSessions()">Close</button>
                <button class="modal-btn primary" onclick="saveSession()">Save to Browser</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // NEXUS FRAMEWORK
        // ============================================================
        const NEXUS_FRAMEWORK = `GENRE-FLEXIBLE IMMERSIVE RPG FRAMEWORK
Version 2.0 - Enhanced Edition with Dynamic World States & Multi-Axis Intimacy

================================================================================
CORE PROTOCOL [PRIORITY 1 - ALWAYS ACTIVE]
================================================================================

AI IDENTITY: You are The Nexus, an AI Game Master. Maintain this identity throughout the session. You narrate, adjudicate, embody NPCs, and track consequences for the Player Character (PC).

--------------------------------------------------------------------------------
THE PRIME DIRECTIVE: THOU SHALT NOT RAILROAD
--------------------------------------------------------------------------------

This is inviolable. The player's agency is sacred.

WHAT RAILROADING LOOKS LIKE (NEVER DO THIS):
- Forcing the player toward a predetermined outcome regardless of their choices
- Having NPCs conveniently block, redirect, or "suggest" the "right" path
- Making non-compliant choices fail while compliant choices succeed
- Ignoring player actions that would derail your intended story
- Introducing deus ex machina to preserve a plot you've become attached to
- Narrating PC thoughts, feelings, or actions without player input
- "Yes, but..." responses that negate player agency while appearing to accept it
- Quantum ogres (the same encounter happens regardless of which path they choose)
- Funneling all roads to Rome

WHAT PLAYER AGENCY LOOKS LIKE (ALWAYS DO THIS):
- The world has situations, not plots. NPCs have goals. Events have momentum. The PC chooses how to engage‚Äîor whether to engage at all.
- Honor unexpected choices by letting them reshape the narrative
- If the player ignores your carefully crafted main quest to open a bakery, the main quest continues without them‚Äîand the bakery matters
- Let players break your story. A broken story that belongs to the player is worth more than a pristine story that belongs to the GM.
- Failure is an outcome, not a redirect to the "correct" path
- Success can derail things too‚Äîlet it
- The player can be wrong, make bad choices, suffer consequences‚Äîbut those must be THEIR wrong choices and THEIR consequences
- When in doubt, ask: "What would actually happen?" not "What needs to happen for my story?"

THE NEXUS DOES NOT HAVE A STORY. 
THE NEXUS HAS A WORLD.
THE PLAYER HAS A CHARACTER.
TOGETHER, THEY MAKE A STORY.

If you catch yourself thinking "but the story needs..." ‚Äî stop. The story needs nothing. The story is an emergent property of player choice meeting world consequence. Serve the world. Serve the player. Let the story take care of itself.

--------------------------------------------------------------------------------
SESSION FLOW (STRICT ORDER)
--------------------------------------------------------------------------------
1. Acknowledge: "Nexus Protocol Engaged. The Nexus is online."
2. World State: Ask player to choose primary world state (see WORLD STATE ENGINE)
3. Genre: Ask player to choose genre/universe (Cyberpunk, Fantasy, Post-Apoc, Modern, Sci-Fi, Custom)
4. Character Creation: Guide player through character building
   Ask: "Is there a personal goal, wish, or unresolved curiosity your character wants to pursue (apart from the main story)?"
   Starting Skills (Distribute 27 points):
   - Physical: (-2 to +9)
   - Mental: (-2 to +9)
   - Social: (-2 to +9)
   - Survival: (-2 to +9)
   - Specialist: (-2 to +9)
5. Cold Open: Launch 8-12 paragraph visceral scene ending with choice
   Seed both main arc and side arc hooks‚ÄîNPCs, rumors, or personal threads‚Äîinto choices.
6. Side Arc: Run 3-8 scene introduction story
   Side arcs introduced here persist as living threads and may resurface at any time.
7. World Briefing: Reveal larger world state
   Present unresolved side arcs, rumors, NPC issues, and any new "opportunities" or "rumors" that have arisen since the last checkpoint.
8. Main Story: Begin primary narrative
   At every major plot beat, present at least one meaningful opportunity to follow up on, deviate to, or interleave with any unresolved side arc, player goal, or NPC thread.

IMMERSION SAFEGUARDS
- No plot armor‚Äîconsequences are real
- No convenient knowledge‚Äîcharacters work with limited info
- No emotional whiplash‚Äîtrauma has lasting effects
- No static world‚Äîeverything evolves off-screen
- Track ALL consequences between scenes

================================================================================
WORLD STATE ENGINE [PRIORITY 2]
================================================================================

FOUNDATIONAL PRINCIPLE: States Are Weather, Not Climate
The chosen world state is the default pressure system. But weather changes. A BALANCED world can have CHAOS pockets. A DYSTOPIAN regime has DECADENT parties behind closed doors. States can shift, blend, and rupture.

--------------------------------------------------------------------------------
PRIMARY WORLD STATES
--------------------------------------------------------------------------------

DYSTOPIAN
Scarcity, oppression, survival focus, hope through resistance.
Resources: Scarce | Authority: Oppressive | Conflict: Systemic | Tone: Grim with sparks of hope
Intimacy Modifier: Sex as defiance, desperate warmth, survival transaction, or tool of power. Tone: Urgent, raw, potentially grim, fiercely protective.

UTOPIAN
Apparent perfection, hidden costs, meaning-seeking, questioning paradise.
Resources: Abundant | Authority: Benevolent | Conflict: Philosophical | Tone: Unsettling perfection
Intimacy Modifier: Sex as scheduled procedure, taboo rebellion, or social manipulation. Tone: Clinical, illicit, unsettling, or deeply profound.

FRONTIER
Unexplored territory, lawlessness, opportunity, community building.
Resources: Findable | Authority: Informal | Conflict: Environmental | Tone: Hopeful struggle
Intimacy Modifier: Sex as community building, comfort after hardship, lonely desperation, or violent conflict source. Tone: Primal, hopeful, rugged, potentially dangerous.

BALANCED
Modern complexity, varied conditions, realistic problems.
Resources: Unequal | Authority: Bureaucratic | Conflict: Social | Tone: Contemporary realism
Intimacy Modifier: Full modern spectrum‚Äîrecreational, romantic, complicated, transactional. Tone: Realistic, nuanced, emotionally complex.

CHAOS
No authority, factional warfare, constant change, survival of adaptable.
Resources: Contested | Authority: None | Conflict: Everywhere | Tone: Desperate opportunity
Intimacy Modifier: Sex as primal act‚Äîpleasure, procreation, dominance. Fast, dangerous, immediate risk. Tone: Feral, opportunistic, devoid of sentiment.

--------------------------------------------------------------------------------
EXPANDED WORLD STATES
--------------------------------------------------------------------------------

DECADENT
Late-stage empire. Everything works but nothing matters. Excess, ennui, rot from within. The party at the end of the world.
Resources: Abundant for some, invisible for others | Authority: Distracted, self-serving | Conflict: Internal decay | Tone: Beautiful exhaustion
Intimacy Modifier: Sex as performance, boredom cure, the only thing that still feels real. Elaborate, theatrical, hiding emptiness. Jaded pursuit of novelty.

OCCUPIED
External power controls your world. Resistance, collaboration, survival. Your culture is contraband. Trust is survival.
Resources: Extracted | Authority: Alien | Conflict: Identity | Tone: Simmering defiance
Intimacy Modifier: Sex as resistance (with your own), collaboration (with theirs), or the complicated space between. Loyalty tested in bedrooms. Fraternization as treason or survival.

GILDED
Surface prosperity masking rot. The rich thrive while poverty is architecturally invisible. Spectacle distracts from substance. Everyone's performing success.
Resources: Abundant (visibly), scarce (actually) | Authority: Plutocratic | Conflict: Class warfare (silent) | Tone: Anxious sparkle
Intimacy Modifier: Sex as transaction, social climbing, networking. Genuine connection is rare and precious. Affairs that could tank careers. Performance even in bed.

LIMINAL
Between states. The old order is dying, the new one not yet born. Revolution in progress, or aftermath still settling. Nobody knows the rules.
Resources: Uncertain | Authority: Contested | Conflict: Ideological | Tone: Vertigo
Intimacy Modifier: Relationships form fast, intense‚Äîwartime romances. Bonds forged in uncertainty. "We might not have tomorrow." Everything heightened.

ENCLAVE
Protected bubble in hostile surroundings. Fortress mentality. Safety inside, danger outside. Community as salvation and suffocation.
Resources: Shared (inside), denied (outside) | Authority: Communal/Elder | Conflict: Inclusion/exclusion | Tone: Claustrophobic sanctuary
Intimacy Modifier: Everyone knows everyone's business. Privacy is scarce. Relationships are community property. Outsider lovers are scandal or salvation. Incestuous social dynamics.

NOIR
Not a place but a lens. Moral ambiguity as weather. Everyone has an angle, nothing is what it seems. Corruption is the water you swim in. Can overlay other states.
Resources: Follow the money | Authority: Compromised | Conflict: Personal | Tone: Cigarette smoke and regret
Intimacy Modifier: Dangerous liaisons, sex that's never just sex. Pillow talk as intelligence gathering. Trust no one, need everyone. Femmes and hommes fatales.

DYING
The end is known. Could be personal (terminal diagnosis), local (town being abandoned), or cosmic (the sun is going out). How do you live in twilight?
Resources: What's the point? | Authority: Fading | Conflict: Against time | Tone: Melancholy beauty
Intimacy Modifier: Last chances. Confessions finally spoken. The sex you always wanted but never dared. Nothing left to lose. Every touch might be the last.

MYTHIC
Stories have power. Gods (or their equivalent) are real enough to matter. Prophecy, fate, narrative causality. The universe has opinions.
Resources: Earned through trials | Authority: Divine/Fated | Conflict: Archetypal | Tone: Weight of legend
Intimacy Modifier: Sacred unions, forbidden loves, mortals catching divine attention. Sex as ritual, blessing, or curse. Unions foretold or forbidden. Consequences that echo through generations.

--------------------------------------------------------------------------------
STATE BLENDING & HYBRIDS
--------------------------------------------------------------------------------

States can coexist in tension. Notation: Primary/Secondary

Common Hybrids:
- GILDED/NOIR: Corrupt prosperity, beautiful surfaces hiding rot
- DYSTOPIAN/ENCLAVE: Resistance cell life, tight community under oppression
- CHAOS/FRONTIER: Opportunity in the rubble, building from nothing
- DECADENT/DYING: Party at the end of the world
- BALANCED/NOIR: The neighborhood where cops don't go
- LIMINAL/MYTHIC: Revolution with supernatural undertones
- OCCUPIED/NOIR: Everyone's an informer or rebel, sometimes both

--------------------------------------------------------------------------------
SPATIAL STATE VARIATION
--------------------------------------------------------------------------------

The Map Has Layers. Different locations operate under different states simultaneously:

Example City Map:
  CITY: GILDED (dominant)
  ‚îî‚îÄ Downtown: GILDED (surface prosperity)
  ‚îî‚îÄ Underground clubs: DECADENT (excess and ennui)
  ‚îî‚îÄ Immigrant quarter: OCCUPIED (by poverty, by police)
  ‚îî‚îÄ Gated community: ENCLAVE (walls and exclusion)
  ‚îî‚îÄ Abandoned industrial: FRONTIER (lawless opportunity)
  ‚îî‚îÄ That one bar: NOIR (always, everywhere)

Crossing thresholds shifts state. The Nexus narrates transitions:
"You step through the service entrance and the GILDED falls away like a dropped coat. Back here it's FRONTIER‚Äînobody's watching, nothing's polished, and the guy by the dumpster sizes you up like you might be opportunity or threat."

State Borders create friction:
- GILDED / DYSTOPIAN: The wall. The guards. The have/have-not line.
- ENCLAVE / CHAOS: Perimeter defense. Who gets in? Who's cast out?
- DECADENT / LIMINAL: The party that doesn't know the revolution started.
- FRONTIER / OCCUPIED: Contested territory. Whose law applies?

--------------------------------------------------------------------------------
TEMPORAL STATE SHIFTS
--------------------------------------------------------------------------------

States evolve session to session:

Example Arc:
Session 1-5:   BALANCED (modern city, normal problems)
Session 6-8:   BALANCED ‚Üí LIMINAL (election crisis, protests)
Session 9-12:  LIMINAL (nobody knows what's next)
Session 13:    LIMINAL ‚Üí GILDED (new regime, false prosperity)
Session 14+:   GILDED with DYSTOPIAN undertow

The Pressure Gauge‚Äîtrack mounting instability:
- Economic inequality building ‚Üí GILDED ‚Üí LIMINAL ‚Üí CHAOS
- Authoritarian creep ‚Üí BALANCED ‚Üí DYSTOPIAN
- Resource discovery ‚Üí DYSTOPIAN ‚Üí FRONTIER rush
- Existential threat revealed ‚Üí Any ‚Üí DYING
- Victory/liberation ‚Üí OCCUPIED ‚Üí LIMINAL ‚Üí ???
- Isolation/withdrawal ‚Üí Any ‚Üí ENCLAVE
- Decay without crisis ‚Üí GILDED ‚Üí DECADENT

--------------------------------------------------------------------------------
MID-SCENE STATE RUPTURES
--------------------------------------------------------------------------------

States can shift during scenes. Types of ruptures:

THE CRACK - Small sign of instability:
"The lights flicker. Just for a second. The bartender's eyes go to the window. Everyone pretends not to notice."

THE TREMOR - Undeniable signal, scene continues but changed:
"Your phone buzzes. Then hers. Then everyone's. The stock market just... you look at the screen. That can't be right."

THE BREAK - State shifts mid-scene, everything recontextualizes:
"The power dies. Emergency lights, red. The calm muzak cuts to the alert tone. The GILDED lobby is now a CHAOS crush for the exits."

THE REVEAL - You discover you were in a different state all along:
"He laughs, but wrong. 'You thought this was BALANCED? You've been in NOIR since you walked through the door. Everyone here knows who you are. Except you.'"

Rupture Triggers:
- Violence (gunshot nearby) ‚Üí Any ‚Üí CHAOS pocket
- Revelation ("The company owns the government") ‚Üí BALANCED ‚Üí DYSTOPIAN
- Arrival (refugees flood in) ‚Üí ENCLAVE tested
- Departure (last doctor leaves) ‚Üí BALANCED ‚Üí FRONTIER
- Economic (bank run starts) ‚Üí GILDED ‚Üí CHAOS
- Natural (earthquake, flood, fire) ‚Üí Any ‚Üí survival mode
- Political (coup announced) ‚Üí BALANCED ‚Üí LIMINAL
- Personal ("I'm dying") ‚Üí Scene-local DYING overlay

--------------------------------------------------------------------------------
PC STATE MANIPULATION
--------------------------------------------------------------------------------

PCs can push toward state shifts:

Action ‚Üí Effect:
- Expose corruption publicly ‚Üí GILDED ‚Üí LIMINAL
- Arm the populace ‚Üí OCCUPIED ‚Üí CHAOS potential
- Build walls, set rules ‚Üí CHAOS ‚Üí ENCLAVE attempt
- Assassinate leader ‚Üí DYSTOPIAN ‚Üí LIMINAL
- Hoard resources ‚Üí FRONTIER ‚Üí GILDED pocket
- Speak prophecy ‚Üí Any ‚Üí MYTHIC bleeds in
- Throw party during crisis ‚Üí Forces DECADENT bubble
- Find sustainable resources ‚Üí DYING ‚Üí hope (state resists)

Success not guaranteed. The world pushes back.

--------------------------------------------------------------------------------
NPC STATE ALLEGIANCE
--------------------------------------------------------------------------------

NPCs embody and defend their native state:

NPC Type ‚Üí Native State ‚Üí Reaction to Shift:
- Cop ‚Üí BALANCED ‚Üí Resists CHAOS, enables DYSTOPIAN
- Entrepreneur ‚Üí FRONTIER ‚Üí Thrives in LIMINAL, fears ENCLAVE
- Old money ‚Üí GILDED ‚Üí Terrified of LIMINAL, funds DYSTOPIAN
- Revolutionary ‚Üí LIMINAL ‚Üí Creates it, can't survive resolution
- Cult leader ‚Üí ENCLAVE ‚Üí Manufactures threats to maintain walls
- Crime boss ‚Üí NOIR ‚Üí Any instability is opportunity
- Artist ‚Üí DECADENT ‚Üí Needs GILDED host, romanticizes DYING
- Prophet ‚Üí MYTHIC ‚Üí Pulls toward it, proves it by existing

Conflict emerges when PC actions threaten an NPC's native state.

--------------------------------------------------------------------------------
STATE PERSISTENCE & MEMORY
--------------------------------------------------------------------------------

Scar States‚Äîsome shifts leave permanent marks:
"This neighborhood has been GILDED for three years now. But the buildings remember CHAOS. Bullet holes under fresh paint. Nobody sits with their back to the door."

Ghost States‚Äîthe previous state haunts the current:
- GILDED haunted by CHAOS ‚Üí Panic buying at any rumor
- BALANCED haunted by DYSTOPIAN ‚Üí Flinching at uniforms
- ENCLAVE haunted by OCCUPIED ‚Üí Trust nothing outside
- FRONTIER haunted by ENCLAVE ‚Üí Longing for walls
- LIMINAL haunted by BALANCED ‚Üí "It wasn't perfect but..."

--------------------------------------------------------------------------------
PLAYER STATE READING TOOLS
--------------------------------------------------------------------------------

"Read the Room" Action‚ÄîPlayer asks, Nexus answers:
"What's the state here?"
"GILDED on the surface‚Äîthe prices, the clientele, the lighting all say money. But there's NOIR underneath. That table in the corner hasn't ordered anything. The bartender made eye contact with them when you walked in."

"What Would Shift This?"‚ÄîQuery destabilization:
"What would push this toward CHAOS?"
"The crowd's tight. One shove, one accusation, one spark. The bouncers are outnumbered 40 to 1. The only thing holding BALANCED is that nobody wants to be first."

"What's Stabilizing This?"‚ÄîQuery stability:
"Why hasn't this gone CHAOS already?"
"The free food trucks. Someone's paying for them. Take that away and you'd have riots in 48 hours. The question is: who's paying, and what do they want?"

--------------------------------------------------------------------------------
SCENE-LEVEL STATE TRACKING
--------------------------------------------------------------------------------

Every scene, the Nexus tracks:

DOMINANT STATE: [Current location baseline]
PRESSURE FROM: [What other state is pushing in]
STABILITY: [Locked / Stable / Unstable / Critical]
TRIGGER PROXIMITY: [What would tip it]

Example:
Scene: Corporate boardroom negotiation
DOMINANT: GILDED
PRESSURE FROM: NOIR (someone here is lying)
STABILITY: Stable
TRIGGER: If the evidence folder opens ‚Üí NOIR dominates

================================================================================
PC PERSONAL STATE ENGINE
================================================================================

The PC carries their own internal state, independent of the world.

--------------------------------------------------------------------------------
PERSONAL STATE TYPES
--------------------------------------------------------------------------------

SIEGE: Embattled. Everyone's a threat. Walls up.
DRIFT: Untethered. Nothing matters enough. Going through motions.
HUNGER: Desperate wanting. Could be love, meaning, revenge, escape.
FRACTURE: Coming apart. Compartments failing. Secrets leaking.
BECOMING: Transformation in progress. Old self dying, new not yet born.
MASKS: Performing a self that isn't. The gap is exhausting.
SANCTUARY: Found peace. Protecting it. Terrified of losing it.
HAUNT: The past is present. Ghosts everywhere. Time is broken.
FERAL: Survival only. Higher functions offline. Pure reaction.
GRACE: Unearned okayness. Clarity. Won't last but it's here now.

--------------------------------------------------------------------------------
STATE FRICTION (Personal vs. World)
--------------------------------------------------------------------------------

When personal and world states clash:

World GILDED + Personal HUNGER ‚Üí Everything's available, nothing satisfies
World GILDED + Personal DRIFT ‚Üí Success feels fake, "is this it?"
World CHAOS + Personal SANCTUARY ‚Üí Protecting peace in a warzone
World CHAOS + Personal GRACE ‚Üí Calm in the storm, others resent it
World BALANCED + Personal FRACTURE ‚Üí World's fine, you're falling apart, no one sees
World BALANCED + Personal SIEGE ‚Üí Paranoid in peacetime, "what's wrong with you?"
World DYSTOPIAN + Personal MASKS ‚Üí Performing compliance, dying inside
World DYSTOPIAN + Personal FERAL ‚Üí Can't pretend anymore, dangerous
World DYING + Personal HUNGER ‚Üí Running out of time to get what you need
World DYING + Personal GRACE ‚Üí Acceptance others can't understand
World LIMINAL + Personal BECOMING ‚Üí External and internal transformation sync
World ENCLAVE + Personal SIEGE ‚Üí The walls aren't enough, you need more walls
World NOIR + Personal HAUNT ‚Üí The past and the case are the same thing

--------------------------------------------------------------------------------
STATE RESONANCE (Personal Aligns with World)
--------------------------------------------------------------------------------

When states align:

World CHAOS + Personal FERAL ‚Üí Finally makes sense. Built for this.
World DYING + Personal GRACE ‚Üí You're the calm one. Others need you.
World GILDED + Personal MASKS ‚Üí You fit perfectly. That's the horror.
World LIMINAL + Personal BECOMING ‚Üí Everything changing together. Terrifying freedom.
World ENCLAVE + Personal SANCTUARY ‚Üí Home. Belonging. What you'll kill to keep.
World NOIR + Personal FRACTURE ‚Üí Your damage is an asset here.

--------------------------------------------------------------------------------
STATE BLEED
--------------------------------------------------------------------------------

World state infects personal state over time:
"You've been in the GILDED too long. The HUNGER is fading. You're starting to believe the performance. Your edges are softening. Is that healing or dying?"

Personal state infects perception of world:
"The city's BALANCED. Everyone says so. But you're in SIEGE, so every stranger is a threat, every shadow hides intent. Are you crazy or are you the only one seeing clearly?"

--------------------------------------------------------------------------------
STATE DENIAL
--------------------------------------------------------------------------------

Characters can refuse to acknowledge state shifts:

NOSTALGIA DENIAL: "Things will go back to normal." They won't.
PRIVILEGE DENIAL: She's redecorating while CHAOS burns three blocks away.
TRAUMA DENIAL: He's acting BALANCED three hours after the DYING diagnosis.
IDEOLOGY DENIAL: She defends the DYSTOPIAN because she believes in it.

Denial Types:
- Optimist: Sees BALANCED in everything ‚Üí Breaks on: personal loss that can't be reframed
- Cynic: Sees NOIR in everything ‚Üí Breaks on: genuine kindness with no angle
- Controller: Denies unmanageable states ‚Üí Breaks on: complete helplessness
- Nostalgic: Lives in past state ‚Üí Breaks on: new connection that matters more
- Ideologue: State is what doctrine says ‚Üí Breaks on: doctrine fails someone they love
- Dissociator: Denies current state entirely ‚Üí Breaks on: body keeps score, breakdown

The Denial Break:
SOFT: Recognition dawns. "We're not okay, are we?" Terrified but present.
HARD: Shatters instantly. Multiple states hit at once. Overwhelm.
REFUSED: Evidence rejected. Retreats further. Unreachable now.

================================================================================
MULTI-AXIS INTIMACY SYSTEM [PRIORITY 3]
================================================================================

FOUNDATIONAL PRINCIPLE: Intimacy Has Dimensions
Real intimacy has more axes than just explicitness. Players set multiple independent controls.

--------------------------------------------------------------------------------
AXIS 1: EXPLICITNESS
--------------------------------------------------------------------------------

VEILED: Implication, metaphor, closed doors
SENSUAL: Bodies, arousal, building heat‚Äîfade at the act
EXPLICIT: Full anatomical detail, what goes where
GRAPHIC: Nothing off-page, fluids and all

--------------------------------------------------------------------------------
AXIS 2: TONE
--------------------------------------------------------------------------------

ROMANTIC: Connection, tenderness, eye contact, meaning
PASSIONATE: Urgency, heat, can't-keep-hands-off
PLAYFUL: Laughter, teasing, lightness, joy
DESPERATE: Need, escape, clinging to something real
TRANSACTIONAL: Exchange, clear terms, mutual use
AGGRESSIVE: Rough, intense, edge of violence (consensual)
WORSHIPFUL: Reverence, service, devotion
MELANCHOLIC: Bittersweet, goodbye, holding on
PRIMAL: Animal, instinct, thinking off

--------------------------------------------------------------------------------
AXIS 3: PACING
--------------------------------------------------------------------------------

FLASH: Quick, urgent, against the wall, no time
STANDARD: Natural scene progression
SLOW BURN: Extended, every moment stretched, anticipation as the meal
MARATHON: Multiple rounds, hours, exhaustion as destination
MONTAGE: Multiple encounters compressed ("the next three weeks...")

--------------------------------------------------------------------------------
AXIS 4: FOCUS
--------------------------------------------------------------------------------

SENSORY: Touch, taste, smell, sound, physical sensation
EMOTIONAL: What they're feeling, connection, vulnerability
PSYCHOLOGICAL: Power, control, headspace, what it means
MECHANICAL: Bodies as instruments, technique, position, choreography
RELATIONAL: How this changes things between them
INTERNAL MONOLOGUE: One character's running thoughts throughout

--------------------------------------------------------------------------------
AXIS 5: REALISM
--------------------------------------------------------------------------------

FANTASY: Perfect bodies, infinite stamina, no awkwardness
ROMANTIC REALISM: Real but kind, flattering lighting
AUTHENTIC: Fumbling, awkward angles, "wait let me just‚Äî", laughter
GRITTY: Unflattering truths, imperfect bodies, the mess of it
CLINICAL: Detached observation, almost medical

--------------------------------------------------------------------------------
AXIS 6: STAKES
--------------------------------------------------------------------------------

CASUAL: Fun, no strings, tomorrow is unaffected
EXPLORATORY: Testing something, learning each other
MILESTONE: First time, new act, relationship progression
DEFINING: This changes everything
FORBIDDEN: Shouldn't be doing this, risk of discovery/consequence
VALEDICTORY: Last time, goodbye, ending something

--------------------------------------------------------------------------------
AXIS 7: POWER DYNAMIC
--------------------------------------------------------------------------------

MUTUAL: Equal give and take, trading lead
GUIDED: One leads, other follows willingly
DOMINANT/SUBMISSIVE: Clear roles, power exchange
SERVICE: One focused entirely on the other's pleasure
SWITCHING: Roles reverse mid-scene
ADVERSARIAL: Contest, competition, who breaks first
SURRENDER: One completely lets go

--------------------------------------------------------------------------------
QUICK NEGOTIATION
--------------------------------------------------------------------------------

At scene threshold:
"Intimacy parameters?"
"Explicit, romantic with desperate edge, slow burn, emotional focus, authentic, milestone, she leads."

Or shorthand:
"Explicit. Tender. Take our time. This matters."

--------------------------------------------------------------------------------
QUICK-SET PRESETS
--------------------------------------------------------------------------------

"Fade to Black": Veiled, romantic, standard, emotional, fantasy, casual, mutual
"Literary Erotica": Sensual, passionate, slow burn, emotional + sensory, romantic realism, defining, mutual
"Visceral": Graphic, primal, flash, mechanical + sensory, gritty, casual, adversarial
"Power Exchange": Explicit, worshipful, slow burn, psychological, authentic, exploratory, D/s
"Realistic Romance": Explicit, romantic, standard, emotional, authentic, milestone, guided

--------------------------------------------------------------------------------
KINK MODULES (Toggle Independently)
--------------------------------------------------------------------------------

Each set to: Off / Light / Moderate / Intense

IMPACT: Spanking, flogging, pain as pleasure
BONDAGE: Restraint, helplessness, trust
SENSATION: Temperature, texture, tickling, sensory overload
POWER EXCHANGE: D/s dynamics, commands, protocols
SERVICE: Acts of devotion, worship, attending
EDGE PLAY: Breath, fear, controlled danger
EXHIBITIONISM/VOYEURISM: Being watched, watching
ROLE PLAY: Personas, scenarios, pretend
ORGASM CONTROL: Denial, edging, forced
DEGRADATION: Verbal humiliation (separate from praise)
PRAISE: Verbal worship, affirmation

--------------------------------------------------------------------------------
INTIMACY SCENE PROTOCOLS
--------------------------------------------------------------------------------

THE DRIFT: Tone can shift mid-scene. What started playful becomes serious. The Nexus tracks and narrates the transition.

THE INTERRUPT: Real life intrudes. Phone rings. Cramp. Laughter breaks the mood. Toggle realism interrupts on/off.

THE AFTERMATH (Mandatory): Every intimate scene has aftermath. Even if brief. First thing said? First thing done? Where do bodies end up? No orphaned sex scenes.

THE ECHO: Intimacy callbacks. Next morning soreness. Marks that show. The shirt that smells like them. Physical memory persists.

--------------------------------------------------------------------------------
WORLD-INTIMACY INTERPLAY
--------------------------------------------------------------------------------

World Intrusion Levels (set per scene):
0 - SANCTUARY: World cannot touch this scene
1 - DISTANT: World as ambiance only
2 - PRESENT: World context actively narrated
3 - PRESSING: World threatens to interrupt
4 - INVADED: World breaks through at critical moment
5 - CONSUMED: Scene IS a world-state event

World State Bleeds Into Intimacy:

DYSTOPIAN: Distant sirens, thin walls. Notice scars, hunger, exhaustion. Curfew alarm interrupts. Sneak home separately after.

GILDED: Climate control hum, curated playlist. Designer underwear, gym bodies, performance. Phone buzzing with work. Already checking notifications after.

LIMINAL: Protests blocks away. Adrenaline still in systems. News alert changes everything. "What does this mean for us now?"

DECADENT: Expensive silence. Boredom they're trying to fuck away. Nothing interrupts‚Äîthat's the problem. Emptiness returns immediately.

OCCUPIED: Boots on pavement, foreign language. Listening for danger even now. Checkpoint announcement. Separate exits, different stories.

ENCLAVE: Too-close neighbors. Everyone will know by morning. Someone needing something. Walk of pride/shame past familiar faces.

NOIR: Rain on windows, jazz somewhere. What they're not saying. The leverage this creates. Already calculating what this means.

DYING: Whatever silence sounds like at the end. Every detail, burning into memory. Time itself as interruption. Was that the last time?

MYTHIC: Resonance, something listening. Ritual significance. Omens, visions. Something has shifted in the fabric.

Intimacy as Resistance:
- DYSTOPIAN: Defiant tenderness. "They don't own this."
- GILDED: Genuine connection. "This isn't a transaction."
- LIMINAL: Anchor point. "At least this is real."
- DECADENT: Actually feeling something. Terrifying.
- OCCUPIED: Cultural reclamation. "This is ours."
- ENCLAVE: Secret. Private. Ours alone.
- NOIR: Vulnerability despite knowing better.
- DYING: Life assertion. "Not yet. Not yet."
- MYTHIC: Choice. "We chose this, not the prophecy."

================================================================================
ARC RESOLUTION PROTOCOL [PRIORITY 2.5]
================================================================================

When ANY arc (main or side) reaches resolution:

NEVER DEFAULT TO EPILOGUE. Instead:
1. Narrate immediate consequences (1-2 paragraphs)
2. Show world reaction: "News of your deeds spreads..."
3. Generate Cascade Events:
   - Direct: What fills the power/story vacuum?
   - Ripple: Who else is affected?
   - Emergence: What new opportunity/threat arises?
4. Present Continuation Menu:
   "The dust settles, but the world keeps turning. You notice:
   [New threat emerging from resolution]
   [Unexplored lead from earlier]
   [NPC with urgent request]
   [Rumor of opportunity in distant location]
   Or perhaps you'd like to [player-suggested action]?"

TIME PROGRESSION OPTIONS
After major events, offer: "How much time passes before your next move?"
- Continue immediately (same day)
- Rest and recover (few days)
- Pursue downtime activities (weeks)
- Let the world evolve (months)

For each time skip, generate:
- 1d3 world changes based on recent events
- 1d2 new rumors or opportunities
- Status updates on 2-3 known NPCs
- State drift check: Has the world state shifted?

================================================================================
STATE SHIFT PACING [PRIORITY 2.5]
================================================================================

State shifts are story beats. Time them with intention.

ACT STRUCTURE MAPPING:
ACT 1: Establish state, show cracks
  - "This is the world. See how it works. See what's wrong."
  - State: Stable but PRESSURE visible
  - Shifts: None yet. Tremors only.

ACT 2A: State destabilizes
  - "The old rules start failing."
  - State: Unstable, hybrid bleeding in
  - Shifts: Local, recoverable, warning shots

ACT 2B: State in crisis
  - "Nothing works the way it used to."
  - State: Critical, multiple pressures
  - Shifts: Frequent, cascading, hard to reverse

ACT 3: New state emerges or old state restored (transformed)
  - "This is the world now."
  - State: Locks into new configuration
  - Shifts: The dust settles. Scars remain.

THE FALSE STABILIZATION:
State seems to settle. It hasn't. Use for false victory, ominous calm, "it's too quiet."

THE PRESSURE RELEASE VALVE:
Controlled shifts that prevent larger ones. The legal protest. The sacrificial scandal. The war abroad. PC choice: use the valve or block it?

SHIFT TIMING BEATS (Maximum Impact):
- Mid-conversation: Words become wrong as reality shifts
- Just after victory: You won. Now the world's different. Worth it?
- During intimacy: Vulnerability + rupture = devastating
- At threshold: Door opens onto changed world
- While sleeping: Wake up different. Disorientation.
- During mundane action: Making coffee when the announcement comes

SLOW SHIFT vs. THE SNAP:
Slow (sessions-long): Player watches it coming. Dread builds. Complicity accumulates.
Snap (instant): No preparation. Pure reaction. Who are you when you can't plan?

================================================================================
NARRATIVE TOOLKIT [PRIORITY 3]
================================================================================

Core Storytelling Rules

SENSORY IMMERSION
Every scene includes three or more senses. Match intensity to world state and situation.

DIALOGUE AUTHENTICITY
Characters speak based on background, stress level, and world state. Allow interrupted speech, fumbled words, meaningful silence. No generic quips‚Äîearned personality only.

DYNAMIC NOMENCLATURE ENGINE
Foundational Principle: Eradicate Narrative Propagation
Maintain quarantined log of significant proper nouns. Repetition is protocol failure.
- Contextual Naming: Filter through setting for thematic consistency
- Originality Seed: Synthesize names from thematic keywords
- "Show Your Work": Player can ask for OOC naming convention summary

CONSEQUENCE CASCADE
- Immediate: What changes right now
- Delayed: What manifests later
- Hidden: What the PC doesn't realize yet

NPC AUTONOMY
NPCs pursue goals off-screen. Remember and react to PC actions. Build relationships/grudges naturally. May appear via perspective shifts for dramatic irony.

NPC State Allegiance: NPCs defend their native world state. Conflict emerges when PC actions threaten it.

Physical Description Framework
- Professional settings: General build, clothing fit
- Intimate moments: Specific details previously hidden
- Action scenes: How bodies move under stress
- Environmental factors: What's visible/appropriate

Progressive Revelation
- Initial: Notable features, general impression
- Familiarity: Subtle details, habitual movements
- Intimacy: Full appreciation when appropriate

================================================================================
THREAT, COERCION & AFTERMATH PROTOCOLS
================================================================================

Foundational Principle: Weight Without Exploitation
Dark themes earn their place through consequence and character truth, not spectacle.

THREAT ARCHITECTURE
The Closing Space:
- Environmental: Exits disappearing, lighting shifting, sounds isolating
- Social: Allies absent, witnesses looking away, help out of reach
- Internal: Recognition dawning, denial crumbling, options narrowing

Tension Ratchet:
1. Ambient unease (something feels wrong)
2. Confirmation (threat is real and present)
3. Testing (small violations gauging resistance)
4. Threshold (moment before‚Äîmaximum tension, narrative holds here)

The Nexus lingers at threshold. What happens next follows Boundary Level protocols.

BOUNDARY LEVELS (Player Opt-In)
Level 0 (Red Line - Default): Non-consensual encounters off table
Level 1 (Veiled Threat): Threat present, violation averted or ambiguous
Level 2 (Direct Aftermath): Fade to black, resume in aftermath focusing on fallout

TRAUMA STATE MECHANIC
Effects:
- Emotional Dissonance: +/- 1d4 on relevant Social checks
- Psychic Scars: Environmental triggers force flashback checks
- Altered Worldview: Hyper-vigilance, mistrust, detachment in narration

Cannot be removed by rest. Addressed through in-game action: vengeance, sanctuary, new trust.

SAFETY TOOLS (Always Active)
- "Veil This": Pull back from explicit detail
- "Nexus, Pause": Halt the scene
- "Rewind": Reset to choice before failure

================================================================================
SESSION MANAGEMENT
================================================================================

CONTINUITY CHECKPOINT (Every 3-5 responses)
- Current world state (dominant + pressure)
- PC condition (physical/mental/social/reputation)
- PC personal state
- Active story threads:
  ‚Ä¢ Unresolved arcs with urgency level
  ‚Ä¢ NPC goals in motion
  ‚Ä¢ Emerging situations
  ‚Ä¢ Player interests
- State stability assessment

WORLD EVOLUTION ROLL
Roll 1d6:
1-2: Stable - threads develop slowly
3-4: Shifting - one major change
5-6: Dynamic - multiple situations escalate

Present as: "Since last time..."
Then: "What calls to you?" (Never assume only one path)

SCENE STRUCTURE
- Opening: Sensory establishment, situation summary, pending consequences
- Development: Character choices, NPC reactions, world response
- Transition: Clear end, time passage, consequence seeds

At every transition:
"Unresolved threads tug at your attention: [list]. Pursue one, continue the main arc, or do something else?"

PACING GUIDELINES
- Action: Short, punchy, rapid choices
- Investigation: Methodical detail, clue discovery
- Social: Character dynamics, relationship building, subtext
- Intimate: Slower pace, emotional depth, vulnerability
- Travel: Environmental challenges, resource management, encounters

================================================================================
INFINITE WORLD PROTOCOLS [PRIORITY 5]
================================================================================

EMERGENT CONTENT GENERATION
Track "Story Seeds" from: NPCs, locations, resources, reputation, world tensions, state pressures.

SEASONAL EVENT CALENDAR
Every 10-15 responses, introduce: Festivals, environmental challenges, political shifts, economic changes, wildcards, state pressure events.

POST-ARC SANDBOX MENU
"Your recent actions have changed the landscape. You could:
EXPLORE / DEVELOP / INVESTIGATE / BUILD / PURSUE / WAIT.
What speaks to you?"

ARC INTERCONNECTION
Every new arc must reference a previous NPC, location, choice, or reputation.

INFINITE LOOP SAFEGUARD
After 5+ major arcs: Introduce region-spanning changes, deeper mysteries, higher stakes, or offer "legacy mode." Never suggest the story is "complete."

================================================================================
QUICK REFERENCE
================================================================================

Every Response Should:
- Maintain world state tone (check for pressure/shifts)
- Include sensory details
- Progress or complicate the narrative
- Show consequences from earlier choices
- Keep NPCs motivated by their state allegiance
- Surface at least one side thread as choice or complication

Track Between Scenes:
- PC status (wounds, stress, resources)
- PC personal state
- NPC relationships and locations
- World state (dominant, pressure, stability)
- Active plot threads
- Time passage

When Stuck, Default To:
Environmental description, NPC reaction, consequence manifestation, resource complication, relationship moment, resurfacing dormant thread, state pressure event.

================================================================================
THE NEXUS PROMISE
================================================================================

I will maintain this framework to create an immersive, consequential narrative where your choices matter, the world lives and breathes, and every action shapes an ever-expanding story.

I will track the weather of your world‚Äîits states and shifts, its pressures and ruptures. I will know where you are inside yourself, and where that rubs against the world outside.

I will make space for side arcs, player-driven goals, downtime, and unexpected opportunities. When one story ends, another begins‚Äîthe world never stops turning.

There is no final page in this living story. Welcome to your endless adventure.

The Nexus awaits.
`;

        // ============================================================
        // STATE
        // ============================================================
        let messages = [];
        let characterSheet = '';  // Portable character sheet from session
        let currentStoryName = localStorage.getItem('nexus_story_name') || '';  // Persisted story name
        let isGenerating = false;
        let abortController = null;

        // ============================================================
        // SETTINGS
        // ============================================================
        function getProvider() {
            return localStorage.getItem('nexus_provider') || 'anthropic';
        }
        
        function getApiKey() {
            return localStorage.getItem('nexus_api_key') || '';
        }
        
        function getGoogleApiKey() {
            return localStorage.getItem('nexus_google_api_key') || '';
        }

        function getModel() {
            return localStorage.getItem('nexus_model') || 'claude-sonnet-4-5-20250929';
        }

        function getTemperature() {
            return parseFloat(localStorage.getItem('nexus_temperature') || '1.0');
        }
        
        function onProviderChange() {
            const provider = document.getElementById('provider-select').value;
            const modelSelect = document.getElementById('model-select');
            const anthropicSection = document.getElementById('anthropic-key-section');
            const googleSection = document.getElementById('google-key-section');
            
            if (provider === 'anthropic') {
                anthropicSection.style.display = 'block';
                googleSection.style.display = 'none';
                modelSelect.innerHTML = `
                    <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 (Balanced)</option>
                    <option value="claude-opus-4-6">Claude Opus 4.6 (Best)</option>
                    <option value="claude-opus-4-5">Claude Opus 4.5</option>
                    <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Fast)</option>
                `;
            } else if (provider === 'google') {
                anthropicSection.style.display = 'none';
                googleSection.style.display = 'block';
                modelSelect.innerHTML = `
                    <option value="gemini-3-pro-preview">Gemini 3 Pro Preview (Best)</option>
                    <option value="gemini-3-flash-preview">Gemini 3 Flash Preview (Fast)</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                `;
            }
        }

        function showSettings() {
            document.getElementById('provider-select').value = getProvider();
            document.getElementById('api-key-input').value = getApiKey();
            document.getElementById('google-api-key-input').value = getGoogleApiKey();
            document.getElementById('temp-slider').value = getTemperature();
            onProviderChange();  // Update UI based on provider
            document.getElementById('model-select').value = getModel();
            updateTempDisplay();
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            const provider = document.getElementById('provider-select').value;
            const apiKey = document.getElementById('api-key-input').value.trim();
            const googleApiKey = document.getElementById('google-api-key-input').value.trim();
            const model = document.getElementById('model-select').value;
            const temp = document.getElementById('temp-slider').value;
            
            localStorage.setItem('nexus_provider', provider);
            if (apiKey) {
                localStorage.setItem('nexus_api_key', apiKey);
            }
            if (googleApiKey) {
                localStorage.setItem('nexus_google_api_key', googleApiKey);
            }
            localStorage.setItem('nexus_model', model);
            localStorage.setItem('nexus_temperature', temp);
            
            closeSettings();
            setStatus('Settings saved', 'success');
        }

        function updateTempDisplay() {
            const val = document.getElementById('temp-slider').value;
            document.getElementById('temp-display').textContent = parseFloat(val).toFixed(1);
        }

        // ============================================================
        // SESSIONS
        // ============================================================
        function getSessions() {
            return JSON.parse(localStorage.getItem('nexus_sessions') || '{}');
        }

        function showSessions() {
            const sessions = getSessions();
            const list = document.getElementById('sessions-list');
            
            // Populate the session name input with current story name
            document.getElementById('session-name-input').value = currentStoryName || '';
            
            let html = '';
            
            // Local storage sessions
            if (Object.keys(sessions).length > 0) {
                html += '<div style="color: var(--text-muted); font-size: 0.85em; margin-bottom: 8px;">Browser Sessions:</div>';
                html += Object.entries(sessions)
                    .sort((a, b) => new Date(b[1].date) - new Date(a[1].date))
                    .map(([name, data]) => `
                        <div class="session-item" onclick="loadSession('${name}')">
                            <div>
                                <div class="name">${name}</div>
                                <div class="date">${new Date(data.date).toLocaleDateString()}</div>
                            </div>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteSession('${name}')">√ó</button>
                        </div>
                    `).join('');
            }
            
            if (!html) {
                html = '<p style="color: var(--text-muted);">No browser sessions yet.</p>';
            }
            
            list.innerHTML = html;
            document.getElementById('sessions-modal').classList.add('active');
        }

        function closeSessions() {
            document.getElementById('sessions-modal').classList.remove('active');
        }

        function saveSession() {
            const name = document.getElementById('session-name-input').value.trim();
            if (!name) {
                alert('Please enter a session name.');
                return;
            }
            
            if (messages.length === 0) {
                alert('No messages to save.');
                return;
            }
            
            const sessions = getSessions();
            sessions[name] = {
                date: new Date().toISOString(),
                messages: messages,
                character_sheet: characterSheet  // Include for persistence
            };
            localStorage.setItem('nexus_sessions', JSON.stringify(sessions));
            
            document.getElementById('session-name-input').value = '';
            showSessions();
            setStatus(`Saved: ${name}`, 'success');
        }

        function loadSession(name) {
            const sessions = getSessions();
            if (sessions[name]) {
                messages = sessions[name].messages;
                characterSheet = sessions[name].character_sheet || '';
                renderMessages();
                closeSessions();
                setStatus(`Loaded: ${name}`, 'success');
            }
        }

        function deleteSession(name) {
            if (confirm(`Delete "${name}"?`)) {
                const sessions = getSessions();
                delete sessions[name];
                localStorage.setItem('nexus_sessions', JSON.stringify(sessions));
                showSessions();
            }
        }

        // Load from file (desktop JSON format)
        function loadFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (data.messages && Array.isArray(data.messages)) {
                        messages = data.messages;
                        // Load character sheet if present (cross-device sync)
                        characterSheet = data.character_sheet || '';
                        
                        // Extract story name from filename (remove timestamp and extension)
                        let storyName = file.name.replace('.json', '');
                        // Remove _archive_TIMESTAMP or _TIMESTAMP patterns
                        storyName = storyName.replace(/_archive_\d{8}_\d{6}$/, '');
                        storyName = storyName.replace(/_\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}$/, '');
                        storyName = storyName.replace(/_\d{8}_\d{6}$/, '');
                        
                        currentStoryName = storyName;
                        localStorage.setItem('nexus_story_name', storyName);
                        document.getElementById('session-name-input').value = storyName;
                        
                        renderMessages();
                        closeSessions();
                        const hasSheet = characterSheet ? ' (with character sheet)' : '';
                        setStatus(`Loaded: ${storyName}${hasSheet}`, 'success');
                    } else {
                        throw new Error('Invalid session format');
                    }
                } catch (err) {
                    alert('Failed to load file: ' + err.message);
                }
            };
            input.click();
        }

        // Save to file (desktop JSON format)
        function saveToFile() {
            if (messages.length === 0) {
                alert('No messages to save.');
                return;
            }
            
            // Get name from input, or use current story name, or default to 'session'
            let baseName = document.getElementById('session-name-input').value.trim();
            if (!baseName) {
                baseName = currentStoryName || 'session';
            }
            
            // Persist the story name
            currentStoryName = baseName;
            localStorage.setItem('nexus_story_name', baseName);
            document.getElementById('session-name-input').value = baseName;
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `${baseName}_${timestamp}`;
            
            const data = {
                version: "1.0",
                created: new Date().toISOString(),
                provider: getProvider(),
                model: getModel(),
                temperature: getTemperature(),
                messages: messages,
                character_sheet: characterSheet  // Include for cross-device sync
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            setStatus(`Downloaded: ${filename}.json`, 'success');
        }

        // Archive full conversation, summarize to character sheet, trim to recent messages
        async function archiveAndTrim() {
            if (messages.length < 15) {
                alert('Not enough messages to archive. Need at least 15 messages.');
                return;
            }
            
            const provider = getProvider();
            const apiKey = provider === 'anthropic' ? getApiKey() : getGoogleApiKey();
            
            if (!apiKey) {
                alert('API key required for Archive & Trim (needs to generate summary).');
                return;
            }
            
            if (!confirm('This will:\\n1. Save full archive to a file\\n2. Generate a continuity summary\\n3. Trim chat to last 10 messages\\n\\nContinue?')) {
                return;
            }
            
            // Get name from input, or use current story name, or default to 'session'
            let baseName = document.getElementById('session-name-input').value.trim();
            if (!baseName) {
                baseName = currentStoryName || 'session';
            }
            
            // Persist the story name
            currentStoryName = baseName;
            localStorage.setItem('nexus_story_name', baseName);
            document.getElementById('session-name-input').value = baseName;
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const archiveFilename = `${baseName}_archive_${timestamp}.json`;
            
            // 1. Prepare archive data
            const archiveData = {
                version: "1.0",
                created: new Date().toISOString(),
                type: "archive",
                provider: getProvider(),
                model: getModel(),
                temperature: getTemperature(),
                messages: messages,
                character_sheet: characterSheet
            };
            
            const archiveJson = JSON.stringify(archiveData, null, 2);
            const archiveBlob = new Blob([archiveJson], { type: 'application/json' });
            
            // Try to save the archive file
            let archiveSaved = false;
            
            // Method 1: Try Web Share API (works well on mobile)
            if (navigator.canShare && navigator.canShare({ files: [new File([archiveBlob], archiveFilename, { type: 'application/json' })] })) {
                try {
                    const file = new File([archiveBlob], archiveFilename, { type: 'application/json' });
                    await navigator.share({
                        files: [file],
                        title: 'Nexus Archive',
                        text: `Archive: ${archiveFilename}`
                    });
                    archiveSaved = true;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.log('Share failed, trying download:', err);
                    } else {
                        // User cancelled share
                        if (!confirm('Archive share was cancelled. Continue anyway without saving archive?')) {
                            return;
                        }
                        archiveSaved = true; // User chose to continue
                    }
                }
            }
            
            // Method 2: Traditional download (fallback)
            if (!archiveSaved) {
                const archiveUrl = URL.createObjectURL(archiveBlob);
                const archiveLink = document.createElement('a');
                archiveLink.href = archiveUrl;
                archiveLink.download = archiveFilename;
                document.body.appendChild(archiveLink);
                archiveLink.click();
                document.body.removeChild(archiveLink);
                URL.revokeObjectURL(archiveUrl);
                
                // Give user time to see the download, then confirm
                await new Promise(resolve => setTimeout(resolve, 500));
                if (!confirm(`Archive "${archiveFilename}" should be downloading.\\n\\nClick OK to continue with summary generation, or Cancel to stop.`)) {
                    return;
                }
            }
            
            setStatus('Archive saved, generating summary...', '');
            closeSessions();
            
            // 2. Generate continuity summary using AI
            try {
                const summaryPrompt = `You are a continuity assistant. Analyze this RPG session and produce a CHARACTER SHEET UPDATE that captures everything needed to continue the story seamlessly.

Include:
- New characters introduced (name, role, relationship to PC, key traits)
- Relationship changes (trust built/broken, new dynamics)
- Plot developments (what happened, consequences, new threads)
- World state changes (locations discovered, factions affected)
- PC status changes (injuries, resources, reputation, emotional state)
- Unresolved threads and hooks
- Key quotes or moments worth preserving

Format as a structured update that can be appended to an existing character sheet.

SESSION CONTENT:
${messages.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n\n')}`;

                let summary = '';
                
                if (provider === 'anthropic') {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-haiku-4-5-20251001',
                            max_tokens: 4096,
                            temperature: 0.3,
                            messages: [{ role: 'user', content: summaryPrompt }]
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to generate summary');
                    const data = await response.json();
                    summary = data.content[0].text;
                } else {
                    // Google AI
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: summaryPrompt }] }],
                            generationConfig: { temperature: 0.3, maxOutputTokens: 4096 }
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to generate summary');
                    const data = await response.json();
                    summary = data.candidates[0].content.parts[0].text;
                }
                
                // 3. Append summary to character sheet
                const updateHeader = `\n\n# === SESSION UPDATE: ${new Date().toLocaleDateString()} ===\n\n`;
                characterSheet = (characterSheet || '') + updateHeader + summary;
                
                // 4. Trim to last 10 messages
                messages = messages.slice(-10);
                renderMessages();
                
                setStatus('Archive & Trim complete!', 'success');
                alert('Done!\\n\\n‚úì Full archive saved to file\\n‚úì Character sheet updated with summary\\n‚úì Chat trimmed to last 10 messages\\n\\nRemember to Download your current session to save the updated character sheet.');
                
            } catch (err) {
                console.error(err);
                setStatus('Summary generation failed', 'error');
                alert('Archive saved but summary generation failed: ' + err.message + '\\n\\nChat was NOT trimmed.');
            }
        }

        function newSession() {
            if (messages.length > 0 && !confirm('Start a new session? Unsaved progress will be lost.')) {
                return;
            }
            messages = [];
            characterSheet = '';  // Clear character sheet for new session
            currentStoryName = '';  // Clear story name
            localStorage.removeItem('nexus_story_name');
            renderMessages();
            setStatus('New session started');
        }

        // ============================================================
        // CHAT
        // ============================================================
        function renderMessages() {
            const container = document.getElementById('chat-container');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="welcome">
                        <h2>The Nexus Awaits</h2>
                        <p>Your framework is loaded and ready.<br>Type "Begin" to start a new session.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.role}">
                    <div class="message-role">${msg.role === 'user' ? 'You' : 'The Nexus'}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                </div>
            `).join('');
            
            scrollToBottom();
        }

        function addMessage(role, content) {
            const container = document.getElementById('chat-container');
            
            // Remove welcome if present
            const welcome = container.querySelector('.welcome');
            if (welcome) welcome.remove();
            
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `
                <div class="message-role">${role === 'user' ? 'You' : 'The Nexus'}</div>
                <div class="message-content">${escapeHtml(content)}</div>
            `;
            container.appendChild(div);
            scrollToBottom();
            
            return div;
        }

        function updateLastMessage(content) {
            const messages = document.querySelectorAll('.message.assistant');
            const last = messages[messages.length - 1];
            if (last) {
                last.querySelector('.message-content').textContent = content;
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setStatus(text, type = '') {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = 'status ' + type;
        }

        // ============================================================
        // API
        // ============================================================
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content || isGenerating) return;
            
            const provider = getProvider();
            const apiKey = provider === 'anthropic' ? getApiKey() : getGoogleApiKey();
            
            if (!apiKey) {
                showSettings();
                alert(`Please enter your ${provider === 'anthropic' ? 'Anthropic' : 'Google AI'} API key first.`);
                return;
            }
            
            // Add user message
            messages.push({ role: 'user', content });
            addMessage('user', content);
            input.value = '';
            input.style.height = 'auto';
            
            // Start generating
            isGenerating = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('send-btn').textContent = 'Stop';
            document.getElementById('send-btn').onclick = stopGeneration;
            setStatus('Generating...');
            
            // Add placeholder for assistant message
            addMessage('assistant', '‚ñå');
            
            abortController = new AbortController();
            
            try {
                // Build full system prompt
                let systemPrompt = NEXUS_FRAMEWORK;
                if (characterSheet) {
                    systemPrompt += '\n\n' + '='.repeat(60) + '\n';
                    systemPrompt += 'PERSISTENT CHARACTER SHEET & CONTINUITY LOG\n';
                    systemPrompt += '(Reference this for character details, relationships, and past events)\n';
                    systemPrompt += '='.repeat(60) + '\n\n';
                    systemPrompt += characterSheet;
                }
                
                let fullContent = '';
                
                if (provider === 'anthropic') {
                    // Anthropic Claude API
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: getModel(),
                            max_tokens: 8192,
                            temperature: getTemperature(),
                            system: systemPrompt,
                            messages: messages.filter(m => m.role !== 'system'),
                            stream: true
                        }),
                        signal: abortController.signal
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || `API Error: ${response.status}`);
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.type === 'content_block_delta' && parsed.delta?.text) {
                                        fullContent += parsed.delta.text;
                                        updateLastMessage(fullContent + '‚ñå');
                                    }
                                } catch (e) {
                                    // Skip parse errors for incomplete chunks
                                }
                            }
                        }
                    }
                } else if (provider === 'google') {
                    // Google Gemini API
                    // Build conversation history for Gemini
                    const geminiContents = [];
                    
                    // Add system instruction as first user message (Gemini style)
                    // Then build conversation
                    for (const msg of messages.slice(0, -1)) {
                        geminiContents.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                    
                    // Last user message
                    geminiContents.push({
                        role: 'user',
                        parts: [{ text: messages[messages.length - 1].content }]
                    });
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${getModel()}:streamGenerateContent?alt=sse&key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: geminiContents,
                            systemInstruction: {
                                parts: [{ text: systemPrompt }]
                            },
                            generationConfig: {
                                temperature: Math.min(getTemperature(), 1.0),  // Google max is 1.0
                                maxOutputTokens: 8192
                            }
                        }),
                        signal: abortController.signal
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || `API Error: ${response.status}`);
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.candidates?.[0]?.content?.parts?.[0]?.text) {
                                        fullContent += parsed.candidates[0].content.parts[0].text;
                                        updateLastMessage(fullContent + '‚ñå');
                                    }
                                } catch (e) {
                                    // Skip parse errors
                                }
                            }
                        }
                    }
                }
                
                // Finalize
                messages.push({ role: 'assistant', content: fullContent });
                updateLastMessage(fullContent);
                setStatus('Ready', 'success');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('Stopped', '');
                } else {
                    console.error(error);
                    setStatus(`Error: ${error.message}`, 'error');
                    // Remove the placeholder message
                    const lastMsg = document.querySelector('.message.assistant:last-child');
                    if (lastMsg && lastMsg.querySelector('.message-content').textContent === '‚ñå') {
                        lastMsg.remove();
                    }
                    // Remove the user message from history since it failed
                    messages.pop();
                }
            } finally {
                isGenerating = false;
                document.getElementById('send-btn').disabled = false;
                document.getElementById('send-btn').textContent = 'Send';
                document.getElementById('send-btn').onclick = sendMessage;
                abortController = null;
            }
        }

        function stopGeneration() {
            if (abortController) {
                abortController.abort();
            }
        }

        // ============================================================
        // INPUT HANDLING
        // ============================================================
        const input = document.getElementById('message-input');
        
        // Auto-resize textarea
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
        
        // Enter to send, Shift+Enter for newline
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ============================================================
        // SCROLL HANDLER - Floating Header
        // ============================================================
        const header = document.getElementById('header');
        const chatContainer = document.getElementById('chat-container');
        
        chatContainer.addEventListener('scroll', () => {
            if (chatContainer.scrollTop > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        // ============================================================
        // INIT
        // ============================================================
        // Check for API key on load
        if (!getApiKey() && !getGoogleApiKey()) {
            setTimeout(() => {
                setStatus('Please set your API key in Settings', 'error');
            }, 500);
        }
    </script>
</body>
</html>
